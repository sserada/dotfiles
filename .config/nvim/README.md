# Neovim 設定ガイド

このドキュメントでは、Neovimの基礎操作とプラグインの使い方を解説します。

## 目次

- [Neovim基礎操作](#neovim基礎操作)
- [カスタムキーマップ](#カスタムキーマップ)
- [プラグイン操作ガイド](#プラグイン操作ガイド)
- [設定ファイル構造](#設定ファイル構造)
- [トラブルシューティング](#トラブルシューティング)

---

## Neovim基礎操作

### モードの種類

Neovimには複数のモードがあり、モードによって操作が異なります:

| モード           | 説明                               | 入り方                  | 抜け方          |
| ---------------- | ---------------------------------- | ----------------------- | --------------- |
| **Normal**       | カーソル移動、コマンド実行         | 起動時のデフォルト      | -               |
| **Insert**       | テキスト入力                       | `i`, `a`, `o` など      | `Esc` または `jk`/`kj` |
| **Visual**       | テキスト選択                       | `v` (文字), `V` (行), `Ctrl-v` (矩形) | `Esc` |
| **Command**      | コマンド入力                       | `:`                     | `Enter` または `Esc` |
| **Terminal**     | ターミナルモード                   | `:terminal` または `<C-\>` | `Esc` または `<C-\><C-n>` |

### 基本操作

#### ファイル操作

| コマンド         | 説明                               |
| ---------------- | ---------------------------------- |
| `:e <ファイル名>` | ファイルを開く                     |
| `:w`             | 保存                               |
| `:wq` または `:x` | 保存して終了                       |
| `:q`             | 終了                               |
| `:q!`            | 保存せずに終了                     |

#### カーソル移動（Normalモード）

| キー             | 説明                               |
| ---------------- | ---------------------------------- |
| `h` `j` `k` `l`  | 左、下、上、右へ移動               |
| `w`              | 次の単語の先頭へ                   |
| `b`              | 前の単語の先頭へ                   |
| `e`              | 単語の末尾へ                       |
| `0`              | 行頭へ                             |
| `$`              | 行末へ                             |
| `gg`             | ファイルの先頭へ                   |
| `G`              | ファイルの末尾へ                   |
| `{行番号}G`      | 指定行へジャンプ                   |
| `Ctrl-d`         | 半画面下へスクロール               |
| `Ctrl-u`         | 半画面上へスクロール               |

#### 編集（Normalモード）

| キー             | 説明                               |
| ---------------- | ---------------------------------- |
| `i`              | カーソル位置でInsertモードへ       |
| `a`              | カーソルの次でInsertモードへ       |
| `o`              | 下に新しい行を作成してInsertモードへ |
| `O`              | 上に新しい行を作成してInsertモードへ |
| `x`              | 1文字削除                          |
| `dd`             | 行削除                             |
| `yy`             | 行をコピー（ヤンク）               |
| `p`              | カーソル後にペースト               |
| `P`              | カーソル前にペースト               |
| `u`              | 元に戻す（Undo）                   |
| `Ctrl-r`         | やり直し（Redo）                   |

#### 検索・置換

| コマンド         | 説明                               |
| ---------------- | ---------------------------------- |
| `/パターン`      | 前方検索                           |
| `?パターン`      | 後方検索                           |
| `n`              | 次の検索結果へ                     |
| `N`              | 前の検索結果へ                     |
| `:%s/old/new/g`  | ファイル全体で置換                 |
| `:%s/old/new/gc` | 確認しながら置換                   |

---

## カスタムキーマップ

この設定では、以下のカスタムキーマップが設定されています:

### 全般

| キー             | モード         | 説明                               |
| ---------------- | -------------- | ---------------------------------- |
| `jk` または `kj` | Insert         | Escキーの代わり（Normalモードへ）  |
| `<leader>`       | -              | スペースキー（プレフィックス）     |

> `<leader>`キーは多くのプラグインコマンドで使用されます。`<leader>`を押した後、0.5秒待つとwhich-keyが利用可能なコマンド一覧を表示します。

---

## プラグイン操作ガイド

### ファイル検索・ナビゲーション

#### Telescope（ファジーファインダー）

**起動方法:**

| キー         | 説明                                      |
| ------------ | ----------------------------------------- |
| `<leader>ff` | プロジェクト内ファイルの検索              |
| `<leader>fr` | 最近開いたファイルの検索                  |
| `<leader>fg` | プロジェクト内文字列のライブ検索（grep）  |
| `<leader>fb` | 開放中バッファの検索                      |

**検索ウィンドウ内の操作:**

| キー    | 説明                                             |
| ------- | ------------------------------------------------ |
| `<C-j>` | 次アイテムの選択                                 |
| `<C-k>` | 前アイテムの選択                                 |
| `<C-q>` | 検索結果をQuickfixリストへ送信し、リストを開く   |
| `<Esc>` | 検索ウィンドウを閉じる                           |

#### Neo-tree（ファイルエクスプローラー）

| キー        | 説明                          |
| ----------- | ----------------------------- |
| `<leader>e` | ファイルツリーの表示/非表示   |
| `<leader>o` | ファイルツリーにフォーカス    |

**ツリー内の操作:**

| キー | 説明                                |
| ---- | ----------------------------------- |
| `l`  | ファイルを開く/ディレクトリを展開   |
| `h`  | ディレクトリを閉じる                |
| `a`  | ファイル/ディレクトリを作成         |
| `d`  | ファイル/ディレクトリを削除         |
| `r`  | リネーム                            |
| `y`  | ファイルパスをコピー                |

#### Flash.nvim（高速移動）

| キー    | モード               | 説明                                   |
| ------- | -------------------- | -------------------------------------- |
| `s`     | Normal, Visual, Operator | Flash検索を開始（画面内の任意の場所へジャンプ） |
| `S`     | Normal, Visual, Operator | Treesitter構文ノードを選択してジャンプ |

**使い方:**
1. Normalモードで`s`を押す
2. ジャンプしたい場所の文字を入力
3. 表示されるラベル文字を入力してジャンプ

### バッファ管理

#### Bufferline（バッファライン）

| キー          | 説明                                     |
| ------------- | ---------------------------------------- |
| `<Tab>`       | 次のバッファへ移動                       |
| `<S-Tab>`     | 前のバッファへ移動                       |
| `<leader>bp`  | バッファをピン留め/解除                  |
| `<leader>bP`  | ピン留めされていないバッファを削除       |
| `<leader>bo`  | 現在のバッファ以外を削除                 |
| `<leader>br`  | 右側のバッファを削除                     |
| `<leader>bl`  | 左側のバッファを削除                     |

### コード編集

#### nvim-cmp（補完）

**Insertモード中に自動的に表示されます:**

| キー             | 説明             |
| ---------------- | ---------------- |
| `<C-j>`          | 次候補の選択     |
| `<C-k>`          | 前候補の選択     |
| `<C-h>`          | 補完の中断       |
| `<C-l>` または `<CR>` | 選択候補の確定   |

#### Comment.lua（コメント）

| キー  | モード | 説明                                    |
| ----- | ------ | --------------------------------------- |
| `gcc` | Normal | 現在行のコメントアウト/アンコメント     |
| `gc`  | Visual | 選択範囲のコメントアウト/アンコメント   |

#### Surround.lua（囲み文字操作）

| 操作 | キー               | 例                        |
| ---- | ------------------ | ------------------------- |
| 追加 | `ys{motion}{char}` | `ysiw"` で単語を`"`で囲む |
| 変更 | `cs{old}{new}`     | `cs"'` で`"`を`'`に変更   |
| 削除 | `ds{char}`         | `ds"` で`"`を削除         |

**Visualモード:**

| キー      | 説明                         |
| --------- | ---------------------------- |
| `S{char}` | 選択範囲を指定した文字で囲む |

**使用例:**
- `ysiw)` - カーソル下の単語を`()`で囲む
- `yss"` - 現在行全体を`"`で囲む
- `cs"'` - `"`を`'`に変更
- `ds(` - `()`を削除

### Git操作

#### Gitsigns

| キー         | モード         | 説明                          |
| ------------ | -------------- | ----------------------------- |
| `]c`         | Normal         | 次の変更箇所（hunk）へ移動    |
| `[c`         | Normal         | 前の変更箇所（hunk）へ移動    |
| `<leader>hs` | Normal, Visual | 変更箇所をステージ            |
| `<leader>hr` | Normal, Visual | 変更箇所の変更をリセット      |
| `<leader>hu` | Normal         | ステージした変更の取り消し    |
| `<leader>hb` | Normal         | 現在行のGit blame情報を表示   |

### LSP・診断

#### Trouble（診断リスト）

| キー         | 説明                                      |
| ------------ | ----------------------------------------- |
| `<leader>xx` | 全ての診断リストを表示/非表示             |
| `<leader>xX` | 現在のバッファの診断リストを表示/非表示   |
| `<leader>cs` | シンボル一覧を表示                        |
| `<leader>cl` | LSP定義/参照/その他を表示                 |
| `<leader>xL` | ロケーションリストを表示                  |
| `<leader>xQ` | Quickfixリストを表示                      |

### ターミナル

#### ToggleTerm

| キー         | モード    | 説明                              |
| ------------ | --------- | --------------------------------- |
| `<C-\>`      | Normal, Terminal | ターミナルの表示/非表示        |
| `<leader>tf` | Normal    | フロートターミナルを開く          |
| `<leader>th` | Normal    | 水平分割ターミナルを開く          |
| `<leader>tv` | Normal    | 垂直分割ターミナルを開く          |

**ターミナルモード内:**
- `<C-\>` で再びターミナルを非表示
- `<Esc>` または `<C-\><C-n>` でNormalモードへ

### UI・通知

#### Noice.nvim（モダンUI）

| キー          | モード         | 説明                           |
| ------------- | -------------- | ------------------------------ |
| `<S-Enter>`   | Command        | コマンドライン出力をリダイレクト |
| `<leader>snl` | Normal         | 最後のメッセージを表示         |
| `<leader>snh` | Normal         | メッセージ履歴を表示           |
| `<leader>sna` | Normal         | 全てのメッセージを表示         |
| `<leader>snd` | Normal         | 全ての通知を消去               |
| `<C-f>`       | Insert, Normal, Select | LSPドキュメントを前方スクロール |
| `<C-b>`       | Insert, Normal, Select | LSPドキュメントを後方スクロール |

#### Which-key（キーマップヘルプ）

`<leader>`キーや他のプレフィックスキーを押すと、0.5秒後に利用可能なコマンド一覧が画面下部にポップアップ表示されます。

### プラグイン管理

#### Lazy.nvim

| コマンド      | 説明                               |
| ------------- | ---------------------------------- |
| `:Lazy`       | プラグインマネージャーを開く       |
| `:Lazy sync`  | プラグインの同期（更新・インストール） |
| `:Lazy clean` | 未使用プラグインの削除             |
| `:Lazy update`| 全プラグインの更新                 |

---

## 設定ファイル構造

```
.config/nvim/
├── init.lua                    # エントリーポイント
├── lua/
│   ├── config/
│   │   ├── init.lua            # 設定モジュールのローダー
│   │   ├── options.lua         # Neovimの基本設定
│   │   ├── keymaps.lua         # カスタムキーマップ
│   │   ├── autocmds.lua        # 自動コマンド
│   │   └── lazy.lua            # プラグインマネージャー設定
│   └── plugins/
│       ├── init.lua            # プラグインローダー
│       ├── completion/         # 補完関連プラグイン
│       ├── editing/            # 編集機能プラグイン
│       ├── finder/             # ファイル検索プラグイン
│       ├── git/                # Git関連プラグイン
│       ├── integration/        # 外部統合プラグイン
│       ├── lsp/                # LSP関連プラグイン
│       └── ui/                 # UI関連プラグイン
└── lazy-lock.json              # プラグインのバージョン固定
```

### 設定のカスタマイズ方法

1. **基本設定の変更**: `lua/config/options.lua`を編集
2. **キーマップの追加**: `lua/config/keymaps.lua`を編集
3. **プラグインの追加**:
   - 適切なカテゴリディレクトリに`.lua`ファイルを作成
   - lazy.nvimのプラグイン仕様に従って記述
   - Neovim再起動で自動的に読み込まれます

詳細なプラグイン仕様は[lua/plugins/README.md](./lua/plugins/README.md)を参照してください。

---

## トラブルシューティング

### プラグインが正しく動作しない

1. プラグインの同期を実行:
   ```
   :Lazy sync
   ```

2. Neovimを再起動

3. エラーメッセージを確認:
   ```
   :messages
   ```

### LSPが動作しない

1. Masonでツールがインストールされているか確認:
   ```
   :Mason
   ```

2. 必要なLSPサーバーをインストール:
   - リストから選択して`i`キーでインストール

3. LSPサーバーの状態を確認:
   ```
   :LspInfo
   ```

### フォーマッターが動作しない

1. Masonでフォーマッターがインストールされているか確認:
   ```
   :Mason
   ```

2. Conform.nvimの設定を確認:
   ```
   :ConformInfo
   ```

### キーマップを忘れた

1. Which-keyを活用:
   - `<leader>`キーを押して0.5秒待つ
   - 利用可能なコマンドが表示されます

2. プラグイン固有のヘルプを確認:
   ```
   :help <プラグイン名>
   ```

### ターミナルが正しく動作しない

1. シェルの設定を確認:
   ```lua
   -- lua/config/options.lua で shell オプションを確認
   vim.opt.shell = "zsh"  -- または "bash" など
   ```

2. ToggleTermの設定を確認:
   - `lua/plugins/integration/toggleterm.lua`

### その他の問題

- Neovimのバージョンを確認（0.9.0以上を推奨）:
  ```
  :version
  ```

- プラグインのログを確認:
  ```
  :Lazy log
  ```

- 設定ファイルの構文エラーを確認:
  ```
  :lua =vim.lsp.get_active_clients()
  ```

---

## 参考リンク

- [Neovim公式ドキュメント](https://neovim.io/doc/)
- [Lazy.nvim](https://github.com/folke/lazy.nvim)
- [プラグイン詳細](./lua/plugins/README.md)
